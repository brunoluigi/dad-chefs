<div class="max-w-4xl mx-auto">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">
        <span class="text-amber-600">ğŸ‘¨â€ğŸ³</span> Sous Chef
      </h1>
      <p class="text-gray-500 text-sm">Your AI-powered kitchen companion</p>
    </div>
    <% if @chat %>
      <%= link_to "New Chat", root_path(new_chat: true), class: "text-amber-600 hover:text-amber-700 font-medium text-sm" %>
    <% end %>
  </div>

  <% if @chat %>
    <%= turbo_stream_from "chat_#{@chat.id}" %>
    
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
      <!-- Messages container -->
      <div id="messages" class="h-[60vh] overflow-y-auto p-6 space-y-4" data-controller="messages-scroll">
        <% if @chat.messages.visible.empty? %>
          <div class="text-center text-gray-400 py-20">
            <div class="text-4xl mb-4">ğŸ‘¨â€ğŸ³</div>
            <p class="font-medium text-gray-600">Your Sous Chef is ready!</p>
            <p class="mt-1">Ask me about recipes, cooking tips, or meal ideas.</p>
          </div>
        <% else %>
          <% @chat.messages.visible.each do |message| %>
            <%= render "home/message", message: message %>
          <% end %>
        <% end %>
      </div>

      <!-- Message input -->
      <div class="border-t border-gray-100 p-4 bg-gray-50">
        <%= form_with(model: @message, url: chat_messages_path(@chat), id: "new_message", class: "flex gap-3 items-end", data: { controller: "chat-form" }) do |form| %>
          <%= form.text_area :content,
              class: "flex-1 rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring focus:ring-amber-200 focus:ring-opacity-50 px-4 py-3 resize-none",
              rows: 2,
              placeholder: "Ask your Sous Chef anything... (Enter for new line, Shift+Enter to send)",
              autofocus: true,
              autocomplete: "off",
              data: { chat_form_target: "input", action: "keydown->chat-form#handleKeydown" } %>
          <%= form.submit "Send",
              class: "rounded-lg bg-amber-600 px-6 py-3 font-semibold text-white shadow-sm hover:bg-amber-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-600 transition-colors cursor-pointer" %>
        <% end %>
      </div>
    </div>

    <p class="text-center text-xs text-gray-400 mt-4">
      Sous Chef powered by <%= @chat.model&.name || "AI" %> â€¢ Conversations saved
    </p>
  <% else %>
    <!-- New chat creation -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
      <div class="text-center mb-8">
        <div class="text-5xl mb-4">ğŸ‘¨â€ğŸ³</div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Chat with Your Sous Chef</h2>
        <p class="text-gray-500">Your AI kitchen companion is ready to help with recipes, cooking tips, and meal planning!</p>
      </div>

      <%= form_with(model: Chat.new, url: chats_path, class: "space-y-4", data: { controller: "chat-form" }) do |form| %>
        <%= form.hidden_field :model, value: "gpt-4.1-nano" %>

        <div>
          <%= form.text_area :prompt,
              class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring focus:ring-amber-200 focus:ring-opacity-50 px-4 py-3",
              rows: 3,
              placeholder: "e.g., What can I make with chicken, rice, and vegetables? (Shift+Enter to send)",
              autofocus: true,
              data: { chat_form_target: "input", action: "keydown->chat-form#handleKeydown" } %>
        </div>

        <div class="text-center">
          <%= form.submit "Ask Sous Chef ğŸ‘¨â€ğŸ³",
              class: "rounded-lg bg-amber-600 px-8 py-3 text-lg font-semibold text-white shadow-sm hover:bg-amber-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-600 transition-colors cursor-pointer" %>
        </div>
      <% end %>

      <div class="mt-8 pt-6 border-t border-gray-100">
        <p class="text-sm text-gray-500 text-center mb-4">Try asking about:</p>
        <div class="flex flex-wrap gap-2 justify-center">
          <span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full text-sm">Quick weeknight dinners</span>
          <span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full text-sm">Kid-friendly meals</span>
          <span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full text-sm">Grilling tips</span>
          <span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full text-sm">Meal prep ideas</span>
        </div>
      </div>
    </div>

    <% if current_user.chats.any? %>
      <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Recent Conversations</h3>
          <% if current_user.chats.count > 5 %>
            <%= link_to "View all â†’", chats_path, class: "text-amber-600 hover:text-amber-700 text-sm font-medium" %>
          <% end %>
        </div>
        <div class="space-y-2">
          <% current_user.chats.order(created_at: :desc).limit(5).each do |chat| %>
            <%= link_to chat_path(chat), class: "block bg-white rounded-lg p-4 shadow-sm border border-gray-100 hover:border-amber-200 transition-colors" do %>
              <div class="flex justify-between items-center">
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-gray-900 truncate">
                    <%= chat.messages.visible.where(role: 'user').first&.content&.truncate(50) || "New conversation" %>
                  </p>
                  <p class="text-sm text-gray-500"><%= time_ago_in_words(chat.created_at) %> ago â€¢ <%= chat.messages.visible.count %> messages</p>
                </div>
                <span class="text-gray-400 ml-2">â†’</span>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

